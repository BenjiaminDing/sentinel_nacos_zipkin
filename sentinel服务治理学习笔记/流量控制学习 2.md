:flags:

## 4.7 @SentinelResource的使用

:factory: 

将限流和降级方法外置到单独的类中

![01](D:/音乐图片/typora图片/image-20220602124118193.png)



![02](D:/音乐图片/typora图片/image-20220602124132788.png)



## 4.8 Sentinel规则持久化

```
解决的问题就是，在dashboard配置降级规则，每次重启服务器都会clear为null,所以将配置的信息保存到服务器的一个位置即使再次启动服务器，也会读取到之前对该接口配置的 降级规则，更人性化
```



![03](D:/音乐图片/typora图片/image-20220602125301057.png)

```
上图是 在创建FilePersistence.java的的文件扫描位置指定 cn.com.benjiamin.shoporder.config.FilePersistence
```

![4](D:/音乐图片/typora图片/image-20220602124518667.png)

```
上图4是持久化配置信息的逻辑，jiang信息保存到硬盘的操作，实现一个框架的接口
下图5就是我在FilePersistence类指定 保存降级规则的文件是json格式的数据
```

![5](D:/音乐图片/typora图片/image-20220602124802367.png)

## 4.9 Feign整合Sentinel

```txt
配置文件需要做配置修改，开启feign对sentinel的支持
```

![6](D:/音乐图片/typora图片/image-20220529230640264.png)



![7](D:/音乐图片/typora图片/image-20220529230727047.png)

```
图7是可以判定 ，order在调用service-product时候出现错误才被拦截进入 这个ProductServiceFallback类， 做出相应的处理
```



![8](D:/音乐图片/typora图片/image-20220602130845330.png)

```

扩展: 如果想在容错类中拿到具体的错误,可以使用下面的方式
ProductServiceFallback不能打印出具体的错误信息，使用 ProductServiceFallbackFactory解决这个问题
```





## ==第五章Gateway--服务网关==





:flags:

众多微服务的缺点

```
这样的架构，会存在着诸多的问题：
客户端多次请求不同的微服务，增加客户端代码或配置编写的复杂性
认证复杂，每个服务都需要独立认证。
存在跨域请求，在一定场景下处理相对复杂。
```

网关来解决这些问题

```
第一步创建微服务api-gateway
第二步添加依赖
比较重要的是在application.yml中添加spring.main.web-application-type=reactive  剔除出网关和tomcat的关系
```

![w1](D:/音乐图片/typora图片/image-20220602201956833.png)

 ![w2](D:/音乐图片/typora图片/image-20220602201853818.png)

![w3](D:/音乐图片/typora图片/image-20220602202223664.png)



​     ==使用上图w3的方式或者使用下面排除web内置容器的方式，建议使用下面这个方式更容易理解==

```
     == 使用上图w3的方式或者使用下面排除web内置容器的方式，建议使用下面这个方式更容易理解==
      
      <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
            <!-- Maven整个生命周期内排除内置容器，排除内置容器导出成war包可以让外部容器运行spring-boot项目-->
            <exclusions>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-tomcat</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        
```

下面是application.yml的内容

```yml
server:
  port: 7000
spring:
  application:
    name: api-gateway
    
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 # 将gateway注册到nacos
        #7-10将当前api-gateway注册到nacos注册中心
    gateway:
      discovery:
        locator:
          enabled: true  #让gateway从nacos获取服务信息
          
      routes:
        - id: product_route
          uri: lb://service-product    #lb指的是负载均衡
#          uri: http://127.0.0.1:8081
          order: 1
          predicates:          #断言判断条件
            - Path=/product-serv/**
            - Before=2022-11-28T00:00:00.000+08:00 #限制请求时间在2019-11-28之前
            - Method=GET
            - Weight=group3, 1
          filters:
            - StripPrefix=1
            #id就是路由到几个微服务
        - id: order_route
          uri: lb://shop-order
#          uri: http://127.0.0.1:8091
          order: 1
          predicates:
            - Path=/order-serv/**
            - Weight=group3, 9
          filters:
            - StripPrefix=1
#     spring.main.web-application-type=reactive  是提出网关和tomcat的关系
#  main:
#    web-application-type: reactive
```



:black_flag:

自定义断言,案例对age进行自定义访问参数年纪的范围

![w4](D:/音乐图片/typora图片/image-20220602232423992.png)

自定义一个断言处理类

![w5](D:/音乐图片/typora图片/image-20220602232621643.png)

但是参数的参数必须在路径后面，不能在请求体里面，原因目前不知:question::question:

![w6](D:/音乐图片/typora图片/image-20220602232719256.png)

## 5.6过滤器

内置过滤器

![w7](D:/音乐图片/typora图片/image-20220602235437204.png)

![w8](D:/音乐图片/typora图片/image-20220602235404407.png)

自定义局部过滤器

![w9](D:/音乐图片/typora图片/image-20220603100302853.png)

![w10](D:/音乐图片/typora图片/image-20220603100244839.png)

==全局过滤器== 鉴权

![w11](D:/音乐图片/typora图片/image-20220603100530851.png)

```
这里说明下，上图中的123步骤生成token返回给前端，这里就不进行编写了。后续有时间进行编写
```

![w12](D:/音乐图片/typora图片/image-20220603105126287.png)

![w13](D:/音乐图片/typora图片/image-20220603105141148.png)

![w14](D:/音乐图片/typora图片/image-20220603105245057.png)



==网关限流限流降级==

![w15](D:/音乐图片/typora图片/image-20220603193222557.png)

![w16](D:/音乐图片/typora图片/image-20220603193356648.png)





83/140
