 :boom: 01直接流控模式

<img src="D:/音乐图片/typora图片/image-20220525235813108.png" alt="image-20220525235813108" style="zoom:67%;" />

```
抛出的异常如下图
```

![图2](D:/音乐图片/typora图片/image-20220526124230014.png)



 :boom: 02关联流控模式，每秒qps=3

<img src="D:/音乐图片/typora图片/image-20220526001152474.png" alt="image-20220526001152474"  />

![图4](D:/音乐图片/typora图片/image-20220525235837196.png)

![图5](D:/音乐图片/typora图片/image-20220525235903007.png)



```
两个接口通过界面设置关联关系， 
图3设置每秒请求上限3个，使用jemeter压测工具每秒给order/message2发送1/0.2=5次请求，
所以message2的请求已经超过message1设置的关联接口3，图2是message1的接口被限制请求的提示，
适合用于让步，这里就是演示 message2的优先级比message1的高 message1给message2让步
给当前资源（当前资源的qps=3)设置关联资源，当关联资源的请求超过当前资源的qps，也可以说 当关联资源达到阈值时候，就会对当前资源进行限流
```



 :boom: 03 链路流控，针对上级接口的，比关联 更细致控制

先使用两种方式请求order服务器

![6](D:/音乐图片/typora图片/image-20220526001457811.png)



看到注册信息如上图， message就是我们进行链路测试的对象 点击 message右侧的流控，填写下图



![7](D:/音乐图片/typora图片/image-20220526001734533.png)

![8](D:/音乐图片/typora图片/image-20220526002401133.png)

---------------------------------

上述图 567是一个错误的示范，原因就是版本问题；下面是正确的流程

![9](D:/音乐图片/typora图片/image-20220526003125202.png)



![10](D:/音乐图片/typora图片/image-20220526003150272.png)

---

![11](D:/音乐图片/typora图片/image-20220526003652057.png)

```
上图10  入口资源、order/mesage1就是限流 message1入口
说一入口支援配置 哪个入口就会限制哪个入口，如果超过qps大于3就会报错 下图》》
```



![12](D:/音乐图片/typora图片/image-20220526004041959.png)

浏览器提示如图12

![13](D:/音乐图片/typora图片/image-20220526004112139.png)

:boom:  流控效果 --三种 快速失败，预热warm up,排队等待

![14](D:/音乐图片/typora图片/image-20220526123005169.png)

```
第一种就是抛出异常的方式 ，默认异常抛出提示‘  Blocked by Sentinel (flow limiting)“，就是图2
```

![15](D:/音乐图片/typora图片/image-20220526124619962.png)

```
第二种warm up视频里面提示 不好测试 没有进行演示
```

![16](D:/音乐图片/typora图片/image-20220526124757883.png)

```
如下图 设置qps=3  等待使劲按1ms刷新就会 没流控，如果改为500ms就不会被拦截
```

![17](D:/音乐图片/typora图片/image-20220526125510500.png)

:flags:

## 第二部分（降级规则）

图18开始

第一种降级RT

![18](D:/音乐图片/typora图片/image-20220526224237698.png)

![19](D:/音乐图片/typora图片/image-20220526224923382.png)

```
下图是补充知识  1s内Qps=7大于5，也就是1s内的请求次数大于5并且  1/N==300ms>RT=250ms，两个条件都满足 就如下图进行
```

![20](D:/音乐图片/typora图片/image-20220526225347227.png)

被限流的提示语

![21](D:/音乐图片/typora图片/image-20220526232045980.png)

:flags:第二种降级 异常比例

![22](D:/音乐图片/typora图片/image-20220526233106512.png)

![23](D:/音乐图片/typora图片/image-20220526233055465.png)



:flags:第三种降级 异常数

![23](D:/音乐图片/typora图片/image-20220526235138480.png)

![24](D:/音乐图片/typora图片/image-20220526235157809.png)



:flags: 降级规则之  热点规则

![25](D:/音乐图片/typora图片/image-20220527123227003.png)

![26](D:/音乐图片/typora图片/image-20220527123240340.png)

![27](D:/音乐图片/typora图片/image-20220527123250286.png)

```
参数索引是对  message3(String name,String age)  ,name age | 0  1 ，分别就是0 1  下表索引
 当对这个参数限流，qps大于3  就会下面的限流效果，如果这个参数没有传参进来，就不会进行限流
```



![28](D:/音乐图片/typora图片/image-20220527123634348.png)

```
点入热点规则--进行编辑--看到 高级选项
```

![29](D:/音乐图片/typora图片/image-20220527124603554.png)

![30](D:/音乐图片/typora图片/image-20220527124700820.png)

![31](D:/音乐图片/typora图片/image-20220527124719815.png)

```
对图31进行解释，--图29已经对下标 1 age进行设置热点规则， 当age=10传入参数时候，不进行限流
注意图31 的参数配置的地方 当age=10  的时候也可以进行 独立的qps阈值配置，设置qps=100比较大的值不会被拦截，当改为qps=1时候，即使值age=10一样被拦截
```

:flags:  系统规则

自定义

![32](D:/音乐图片/typora图片/image-20220529001825151.png)

![image-20220529001841726](D:/音乐图片/typora图片/image-20220529001841726.png)

:question: :question::question::question:----Question-ben



```
自定义返回异常无效---原因不知


系统保护规则是从应用级别的入口流量进行控制，从单台机器的总体 Load、RT、入口 QPS 、CPU
使用率和线程数五个维度监控应用数据，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。
系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量 (进入应用的流量) 生效
```

![33](D:/音乐图片/typora图片/image-20220602123708399.png)
